<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Budget · Export</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: #050816;
      color: #e5f4ff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
    }
    h1 {
      font-size: 18px;
      margin-bottom: 4px;
    }
    p {
      font-size: 13px;
      color: #9aa6bd;
      margin: 4px 0 10px;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    #refreshBtn {
      background: #00c2ff;
      color: #02040a;
      font-weight: 600;
    }
    #copyBtn {
      background: transparent;
      color: #e5f4ff;
      border: 1px solid rgba(255,255,255,0.4);
    }
    #backBtn {
      background: transparent;
      color: #e5f4ff;
      border: 1px solid rgba(255,255,255,0.4);
    }
    #status {
      font-size: 12px;
      color: #9aa6bd;
      min-height: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid rgba(255,255,255,0.25);
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #11152a;
    }
    tbody tr:nth-child(even) {
      background: #080c1a;
    }
    small {
      font-size: 11px;
      color: #9aa6bd;
    }
  </style>
</head>
<body>
  <h1>Budget · Export</h1>
  <p>This reads your saved budget in this browser and builds a table you can copy into Excel or Google Sheets.</p>

  <div class="row">
    <button id="backBtn">Back to budget</button>
    <button id="refreshBtn">Build table from saved budget</button>
    <button id="copyBtn">Copy table to clipboard</button>
    <input type="file" id="importFile" accept="application/json,.json,.txt">
    <button id="importBtn">Import JSON</button>
    <span id="status"></span>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Type</th>
        <th>Label</th>
        <th>Amount</th>
        <th>Frequency</th>
        <th>Enabled</th>
        <th>Color</th>
        <th>Weekly</th>
        <th>Fortnightly</th>
        <th>Monthly</th>
        <th>Yearly</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p><small>Copy button selects the whole table for you; you can also select rows manually.</small></p>

  <script>
    const STORAGE_KEY_ITEMS = "budgetNeedsWantsItems";

    function formatNumber(n) {
      if (!isFinite(n)) return "";
      return n.toFixed(2).replace(/\.00$/, "");
    }

    function toWeekly(amount, frequency) {
      if (frequency === "fortnightly") return amount / 2;
      if (frequency === "monthly") return amount * (12 / 52);
      if (frequency === "yearly") return amount / 52;
      return amount;
    }

    function fromWeekly(weekly, target) {
      if (target === "fortnightly") return weekly * 2;
      if (target === "monthly") return weekly * (52 / 12);
      if (target === "yearly") return weekly * 52;
      return weekly;
    }

    function buildTable() {
      const statusEl = document.getElementById("status");
      const tbody = document.querySelector("#dataTable tbody");
      statusEl.textContent = "";
      tbody.innerHTML = "";

      const raw = localStorage.getItem(STORAGE_KEY_ITEMS);
      if (!raw) {
        statusEl.textContent = "No saved budget found in this browser.";
        return;
      }

      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch (e) {
        statusEl.textContent = "Could not read saved data (JSON error).";
        return;
      }

      if (!Array.isArray(parsed) || parsed.length === 0) {
        statusEl.textContent = "Saved budget is empty.";
        return;
      }

      let count = 0;

      parsed.forEach((it) => {
        if (typeof it.amount !== "number") return;

        const type = it.type === "want" ? "want" : "need";
        const label = typeof it.label === "string" ? it.label : "";
        const amount = it.amount;
        const freq = ["weekly", "fortnightly", "monthly", "yearly"].includes(it.frequency)
          ? it.frequency
          : "weekly";
        const enabled = it.enabled !== false;
        const color = it.color || "default";

        const weekly = toWeekly(amount, freq);
        const fortnightly = fromWeekly(weekly, "fortnightly");
        const monthly = fromWeekly(weekly, "monthly");
        const yearly = fromWeekly(weekly, "yearly");

        const tr = document.createElement("tr");
        const cells = [
          type,
          label,
          formatNumber(amount),
          freq,
          enabled ? "1" : "0",
          color,
          formatNumber(weekly),
          formatNumber(fortnightly),
          formatNumber(monthly),
          formatNumber(yearly)
        ];

        cells.forEach((val) => {
          const td = document.createElement("td");
          td.textContent = val;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
        count++;
      });

      statusEl.textContent =
        "Table built from " + count + " items. Copy and paste into Excel/Sheets.";
    }

    async function copyTable() {
      const statusEl = document.getElementById("status");
      const table = document.getElementById("dataTable");
      const range = document.createRange();
      range.selectNode(table);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);

      try {
        const ok = document.execCommand("copy");
        if (!ok && navigator.clipboard && navigator.clipboard.writeText) {
          const text = selection.toString();
          await navigator.clipboard.writeText(text);
        }
        statusEl.textContent = "Table copied. Paste into Excel or Google Sheets.";
      } catch (e) {
        statusEl.textContent = "Copy failed. Select the table manually and copy.";
      } finally {
        selection.removeAllRanges();
      }
    }

    function goBack() {
      window.location.href = "index.html";
    }

    async function importBudgetFromFile() {
      const statusEl = document.getElementById("status");
      const fileInput = document.getElementById("importFile");
      const file = fileInput.files && fileInput.files[0];

      if (!file) {
        statusEl.textContent = "Choose a JSON file first.";
        return;
      }

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (!Array.isArray(data)) {
          statusEl.textContent = "Import failed: JSON must be an array.";
          return;
        }

        const cleaned = data
          .filter(it => typeof it.amount === "number")
          .map(it => ({
            type: it.type === "want" ? "want" : "need",
            label: typeof it.label === "string" ? it.label : "untitled",
            amount: it.amount,
            frequency: ["weekly", "fortnightly", "monthly", "yearly"].includes(it.frequency)
              ? it.frequency
              : "weekly",
            enabled: it.enabled !== false,
            color: it.color || "default",
            id: typeof it.id === "number" ? it.id : Date.now() + Math.random()
          }));

        localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(cleaned));

        statusEl.textContent = "Import complete. Table refreshed.";
        buildTable();
      } catch (e) {
        console.error("Import error", e);
        statusEl.textContent = "Import failed: could not read or parse JSON.";
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", buildTable);
    document.getElementById("copyBtn").addEventListener("click", copyTable);
    document.getElementById("backBtn").addEventListener("click", goBack);
    document.getElementById("importBtn").addEventListener("click", importBudgetFromFile);

    buildTable();
  </script>
</body>
</html>
