<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mortgage Calculator ‚Äì Budget Needs vs Wants</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Mortgage calculator tool for the Budget Needs vs Wants planner. Estimate repayments, total interest, and compare to your budget surplus." />

  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #0b1020;
      --bg-soft: #11152a;
      --accent: #00c2ff;
      --accent-soft: rgba(0, 194, 255, 0.15);
      --text: #e5f4ff;
      --muted: #9aa6bd;
      --danger: #ff4d6a;
      --success: #32d788;
      --pill-need: #1b9c5b;
      --pill-want: #cc7a1c;
      --disabled: #555c72;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #101633 0, #050816 40%, #02040a 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      max-width: 960px;
      margin: 0 auto;
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-header {
      padding: 10px 14px 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      background: linear-gradient(to right, rgba(0, 0, 0, 0.5), transparent);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(12px);
    }

    .top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .brand-tagline {
      font-size: 12px;
      color: var(--muted);
    }

    .header-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill-button {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(0, 0, 0, 0.4);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      text-decoration: none;
      white-space: nowrap;
    }

    .pill-button-icon {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.7);
    }

    .pill-button.donate {
      border-color: rgba(255, 255, 255, 0.32);
    }

    .pill-button.donate .pill-button-icon {
      color: #ffcf66;
    }

    .summary-toggle-button {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(0, 0, 0, 0.4);
      color: var(--muted);
      cursor: pointer;
      text-decoration: none;
      white-space: nowrap;
    }

    .summary-toggle-button.active {
      color: var(--text);
      border-color: var(--accent);
      background: rgba(0, 194, 255, 0.18);
    }

    .app-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 6px 12px 12px;
      gap: 10px;
    }

    .panel {
      padding: 10px 10px 12px;
      border-radius: 12px;
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.03), transparent);
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .panel-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 4px;
      gap: 8px;
    }

    .panel-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .panel-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .panel-totals {
      text-align: right;
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }

    .panel-totals-row {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      align-items: center;
    }

    .panel-totals span.amount {
      font-weight: 600;
      margin-left: 2px;
    }

    .type-toggle {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.12);
      gap: 2px;
    }

    .type-option {
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 10px;
      padding: 3px 7px;
      cursor: pointer;
      white-space: nowrap;
    }

    .type-option.active {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }

    .summary-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      align-items: center;
      padding-bottom: 4px;
    }

    .summary-card {
      background: rgba(5, 8, 22, 0.9);
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
    }

    .summary-card-title {
      color: var(--muted);
      font-size: 11px;
    }

    .mini-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 11px;
    }

    .mini-label {
      color: var(--muted);
    }

    .mini-value {
      font-weight: 600;
    }

    .mini-value.surplus {
      color: var(--success);
    }

    .mini-value.deficit {
      color: var(--danger);
    }

    .app-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 10px;
    }

    @media (max-width: 768px) {
      .app-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      input[type="text"],
      input[type="number"],
      select {
        font-size: 16px;
      }
    }

    .inputs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field-label {
      font-size: 11px;
      color: var(--muted);
    }

    .field-inline {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      background: #050816;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      padding: 7px 10px;
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0, 194, 255, 0.4);
    }

    .error-text {
      font-size: 11px;
      color: var(--danger);
      min-height: 14px;
      margin-top: 2px;
    }

    .calculate-btn {
      margin-top: 6px;
      background: var(--accent);
      border: none;
      color: #02040a;
      padding: 7px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 0 14px rgba(0, 194, 255, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .calculate-btn span.icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #02040a;
      color: var(--accent);
      font-size: 14px;
      font-weight: 700;
    }

    .secondary-btn {
      margin-top: 6px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(0, 0, 0, 0.4);
      color: var(--muted);
      padding: 6px 10px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .secondary-btn.good {
      border-color: rgba(50, 215, 136, 0.7);
      color: var(--success);
    }

    .secondary-btn.bad {
      border-color: rgba(255, 77, 106, 0.7);
      color: var(--danger);
    }

    .result-big {
      font-size: 18px;
      font-weight: 600;
    }

    .result-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.4);
      color: var(--muted);
      white-space: nowrap;
    }

    .result-tag.good {
      border-color: rgba(50, 215, 136, 0.7);
      color: var(--success);
    }

    .result-tag.bad {
      border-color: rgba(255, 77, 106, 0.7);
      color: var(--danger);
    }

    .progress-shell {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #35d5ff, #32d788);
      width: 0%;
      transition: width 0.2s ease-out;
    }

    .note {
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
    }

    .hidden-box {
      margin-top: 6px;
      padding: 8px 8px 6px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px dashed rgba(255, 255, 255, 0.14);
      font-size: 11px;
      display: none;
    }

    .toggle-link {
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="top-row">
      <div class="brand">
        <div class="brand-title">Mortgage Calculator</div>
        <div class="brand-tagline">
          Estimate repayments and see how they sit against your surplus.
        </div>
      </div>

      <div class="header-actions">
        <a href="tools.html"
           class="summary-toggle-button active"
           id="backToTools">
          ‚Üê Tools
        </a>

        <a href="index.html"
           class="summary-toggle-button"
           id="backToMain">
          Main planner
        </a>

        <a href="https://buy.stripe.com/5kQaEY0dReTA8fT5FsgnK00"
           class="pill-button donate"
           id="donateLink"
           target="_blank"
           rel="noopener noreferrer">
          <span class="pill-button-icon">üíñ</span>
          Leave a tip
        </a>
      </div>
    </div>
  </header>

  <main class="app-main">
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">
            Affordability snapshot
            <span class="panel-badge">Linked to planner</span>
          </div>
          <div class="panel-subtitle">
            Compare the mortgage payment to the surplus stored in your main budget.
          </div>
        </div>

        <div class="panel-totals">
          <div class="panel-totals-row">
            <label>View as:</label>
            <div class="type-toggle" id="viewToggle">
              <button class="type-option" data-view="weekly">W</button>
              <button class="type-option" data-view="fortnightly">F</button>
              <button class="type-option active" data-view="monthly">M</button>
              <button class="type-option" data-view="yearly">Y</button>
            </div>
          </div>
        </div>
      </div>

      <div class="summary-row">
        <div class="summary-card">
          <div class="summary-card-title">Planner surplus (est)</div>
          <div class="mini-row">
            <span class="mini-label">From main planner</span>
            <span id="plannerSurplus" class="mini-value surplus">0</span>
          </div>
          <div class="mini-row">
            <span class="mini-label">Basis</span>
            <span id="plannerBasis" class="mini-value">‚Äî</span>
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-card-title">Mortgage payment</div>
          <div class="mini-row">
            <span class="mini-label">Payment</span>
            <span id="paymentDisplay" class="mini-value">0</span>
          </div>
          <div class="mini-row">
            <span class="mini-label">Coverage</span>
            <span id="coverageLabel" class="mini-value surplus">Run a calculation</span>
          </div>
          <div class="mini-row">
            <span class="mini-label">Surplus after payment</span>
            <span id="afterPayment" class="mini-value surplus">0</span>
          </div>
        </div>
      </div>
    </section>

    <div class="app-grid">
      <!-- Inputs -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">
              Loan details
            </div>
            <div class="panel-subtitle">
              Adjust the loan amount, rate, and term, then compare to your planner surplus.
            </div>
          </div>
        </div>

        <div class="inputs-grid">
          <div class="field-group">
            <div class="field-label">Property price</div>
            <div class="field-inline">
              <span style="font-size:12px;color:var(--muted);">$</span>
              <input id="priceInput" type="number" min="0" step="1000" placeholder="" />
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Deposit</div>
            <div class="field-inline">
              <span style="font-size:12px;color:var(--muted);">$</span>
              <input id="depositInput" type="number" min="0" step="1000" placeholder="" />
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Interest rate (p.a.)</div>
            <div class="field-inline">
              <input id="rateInput" type="number" min="0" step="0.01" placeholder="" />
              <span style="font-size:12px;color:var(--muted);">%</span>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Future rate (optional)</div>
            <div class="field-inline">
              <input id="futureRateInput" type="number" min="0" step="0.01" placeholder="" />
              <span style="font-size:12px;color:var(--muted);">%</span>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Loan term</div>
            <div class="field-inline">
              <input id="termInput" type="number" min="1" max="40" step="1" placeholder="" />
              <span style="font-size:12px;color:var(--muted);">years</span>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Repayment frequency</div>
            <select id="freqInput">
              <option value="monthly" selected>Monthly</option>
              <option value="fortnightly">Fortnightly</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>

          <div class="field-group">
            <div class="field-label">Extra repayment (optional)</div>
            <div class="field-inline">
              <span style="font-size:12px;color:var(--muted);">$</span>
              <input id="extraInput" type="number" min="0" step="1" placeholder="" />
            </div>
          </div>
        </div>

        <div class="error-text" id="inputError"></div>

        <button class="calculate-btn" id="calcBtn">
          <span class="icon">‚ñ∂</span>
          Calculate repayments
        </button>

        <button class="secondary-btn" id="addToPlannerBtn">
          Add / update mortgage in planner
        </button>

        <div class="note">
          Rough guide only. Does not include fees, changing rates, or lender-specific rules.
        </div>
      </section>

      <!-- Results -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Results</div>
            <div class="panel-subtitle">
              Repayments, total interest, time saved with extra, and a simple future-rate comparison.
            </div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;">
          <div>
            <div class="field-label">Repayment (including extra)</div>
            <div class="result-big" id="resultPayment">‚Äî</div>
            <div class="field-label" id="resultPaymentLabel">Per month</div>
          </div>

          <div>
            <div class="field-label">Total interest over life of loan</div>
            <div class="mini-row">
              <span class="mini-label">Current rate</span>
              <span class="mini-value" id="resultInterestBase">‚Äî</span>
            </div>
            <div class="mini-row">
              <span class="mini-label">With extra repayments</span>
              <span class="mini-value" id="resultInterestExtra">‚Äî</span>
            </div>
          </div>

          <div>
            <div class="field-label">Estimated time saved with extra</div>
            <div class="mini-row">
              <span class="mini-label">Base term</span>
              <span class="mini-value" id="resultTermBase">‚Äî</span>
            </div>
            <div class="mini-row">
              <span class="mini-label">With extra</span>
              <span class="mini-value" id="resultTermExtra">‚Äî</span>
            </div>
          </div>

          <div>
            <div class="field-label">Mortgage vs planner surplus</div>
            <div class="progress-shell">
              <div class="progress-fill" id="coverageBar"></div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <span class="note" id="coverageNote">Run a calculation to compare.</span>
              <span class="result-tag" id="coverageTag">‚Äî</span>
            </div>
          </div>

          <div>
            <div class="field-label">
              Future rate comparison (if you fill the future rate box)
            </div>
            <div class="hidden-box" id="futureBox">
              <div class="mini-row">
                <span class="mini-label">Repayment at future rate</span>
                <span class="mini-value" id="futurePayment">‚Äî</span>
              </div>
              <div class="mini-row">
                <span class="mini-label">Total interest at future rate</span>
                <span class="mini-value" id="futureInterest">‚Äî</span>
              </div>
              <div class="mini-row">
                <span class="mini-label">Change vs current</span>
                <span class="mini-value" id="futureChange">‚Äî</span>
              </div>
            </div>
            <div class="note" id="futureNote">
              Enter a future interest rate to see how repayments and total interest could change.
            </div>
          </div>

          <div>
            <span class="toggle-link" id="detailsToggle">Show calculation notes</span>
            <div class="hidden-box" id="detailsBox">
              <strong>How this calculator works</strong>
              <ul>
                <li>Loan amount = property price minus your deposit.</li>
                <li>Repayments use a standard amortising loan formula based on your rate, term, and chosen frequency.</li>
                <li>Extra repayments are simply added on top of the base repayment and then used to simulate an earlier payoff.</li>
                <li>‚ÄúMortgage vs planner surplus‚Äù compares the repayment to the surplus stored in your main planner for W/F/M/Y.</li>
                <li>The future rate view re-runs the same formula at the alternative rate so you can see how sensitive the loan is to rate changes.</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<script>
  const STORAGE_KEY_INCOME = "budgetNeedsWantsIncome";
  const STORAGE_KEY_ITEMS = "budgetNeedsWantsItems";
  const STORAGE_KEY_MORTGAGE = "budgetMortgageCalcState";

  const viewToggle = document.getElementById("viewToggle");
  const plannerSurplusEl = document.getElementById("plannerSurplus");
  const plannerBasisEl = document.getElementById("plannerBasis");
  const paymentDisplayEl = document.getElementById("paymentDisplay");
  const coverageLabelEl = document.getElementById("coverageLabel");
  const afterPaymentEl = document.getElementById("afterPayment");

  const priceInput = document.getElementById("priceInput");
  const depositInput = document.getElementById("depositInput");
  const rateInput = document.getElementById("rateInput");
  const futureRateInput = document.getElementById("futureRateInput");
  const termInput = document.getElementById("termInput");
  const freqInput = document.getElementById("freqInput");
  const extraInput = document.getElementById("extraInput");
  const inputError = document.getElementById("inputError");
  const calcBtn = document.getElementById("calcBtn");
  const addToPlannerBtn = document.getElementById("addToPlannerBtn");

  const resultPaymentEl = document.getElementById("resultPayment");
  const resultPaymentLabelEl = document.getElementById("resultPaymentLabel");
  const resultInterestBaseEl = document.getElementById("resultInterestBase");
  const resultInterestExtraEl = document.getElementById("resultInterestExtra");
  const resultTermBaseEl = document.getElementById("resultTermBase");
  const resultTermExtraEl = document.getElementById("resultTermExtra");
  const coverageBarEl = document.getElementById("coverageBar");
  const coverageNoteEl = document.getElementById("coverageNote");
  const coverageTagEl = document.getElementById("coverageTag");

  const futureBox = document.getElementById("futureBox");
  const futurePaymentEl = document.getElementById("futurePayment");
  const futureInterestEl = document.getElementById("futureInterest");
  const futureChangeEl = document.getElementById("futureChange");
  const futureNoteEl = document.getElementById("futureNote");

  const detailsToggle = document.getElementById("detailsToggle");
  const detailsBox = document.getElementById("detailsBox");

  let plannerSurplusWeekly = 0;
  let viewMode = "monthly";
  let lastPaymentPerFreq = 0;
  let lastFreq = "monthly";
  let lastPrincipal = 0;
  let lastTermYears = 0;
  let lastRate = 0;

  function formatCurrency(amount) {
    if (!isFinite(amount)) return "‚Äî";
    return "$" + amount.toFixed(2).replace(/\.00$/, "");
  }

  function fromWeekly(amount, freq) {
    if (freq === "fortnightly") return amount * 2;
    if (freq === "monthly") return amount * 52 / 12;
    if (freq === "yearly") return amount * 52;
    return amount;
  }

  function toWeekly(amount, freq) {
    if (freq === "fortnightly") return amount / 2;
    if (freq === "monthly") return amount * 12 / 52;
    if (freq === "yearly") return amount / 52;
    return amount;
  }

  function loadPlannerSurplus() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_INCOME);
      if (!raw) {
        plannerSurplusWeekly = 0;
        plannerSurplusEl.textContent = "0";
        plannerBasisEl.textContent = "No surplus saved yet";
        return;
      }
      const parsed = JSON.parse(raw);
      if (!parsed || typeof parsed !== "object") return;

      const amount = parseFloat(parsed.amount || "0") || 0;
      const freq =
        parsed.frequency === "weekly" ||
        parsed.frequency === "fortnightly" ||
        parsed.frequency === "monthly" ||
        parsed.frequency === "yearly"
          ? parsed.frequency
          : "fortnightly";

      const weekly = toWeekly(amount, freq);
      plannerSurplusWeekly = weekly;

      const display = fromWeekly(weekly, viewMode);
      plannerSurplusEl.textContent = formatCurrency(display).replace("$", "");
      plannerBasisEl.textContent =
        viewMode === "weekly"
          ? "Per week"
          : viewMode === "fortnightly"
          ? "Per fortnight"
          : viewMode === "monthly"
          ? "Per month"
          : "Per year";
    } catch (e) {
      plannerSurplusWeekly = 0;
      plannerSurplusEl.textContent = "0";
      plannerBasisEl.textContent = "No surplus saved yet";
    }
  }

  function annuityPayment(principal, annualRate, years, paymentsPerYear) {
    const n = years * paymentsPerYear;
    if (n <= 0) return 0;
    const r = annualRate / 100 / paymentsPerYear;
    if (r === 0) return principal / n;
    const factor = Math.pow(1 + r, n);
    return (principal * r * factor) / (factor - 1);
  }

  function calculate() {
    const price = parseFloat(priceInput.value || "0");
    const deposit = parseFloat(depositInput.value || "0");
    const rate = parseFloat(rateInput.value || "0");
    const termYears = parseFloat(termInput.value || "0");
    const freq = freqInput.value;
    const extra = parseFloat(extraInput.value || "0");

    if (!isFinite(price) || price <= 0) {
      inputError.textContent = "Enter a property price above 0.";
      priceInput.focus();
      return;
    }
    if (!isFinite(deposit) || deposit < 0) {
      inputError.textContent = "Deposit cannot be negative.";
      depositInput.focus();
      return;
    }
    if (deposit >= price) {
      inputError.textContent = "Deposit must be less than the property price.";
      depositInput.focus();
      return;
    }
    if (!isFinite(rate) || rate <= 0) {
      inputError.textContent = "Enter a positive interest rate.";
      rateInput.focus();
      return;
    }
    if (!isFinite(termYears) || termYears <= 0) {
      inputError.textContent = "Enter a term greater than 0 years.";
      termInput.focus();
      return;
    }
    if (!isFinite(extra) || extra < 0) {
      inputError.textContent = "Extra repayment cannot be negative.";
      extraInput.focus();
      return;
    }

    inputError.textContent = "";

    const principal = price - deposit;
    const paymentsPerYear =
      freq === "weekly" ? 52 : freq === "fortnightly" ? 26 : 12;

    const basePayment = annuityPayment(principal, rate, termYears, paymentsPerYear);
    const paymentWithExtra = basePayment + extra;

    const n = termYears * paymentsPerYear;
    const r = rate / 100 / paymentsPerYear;

    let totalInterestBase;
    if (r === 0) {
      totalInterestBase = 0;
    } else {
      totalInterestBase = basePayment * n - principal;
    }

    let remaining = principal;
    let periodsExtra = 0;
    if (r === 0) {
      periodsExtra = paymentWithExtra > 0 ? Math.ceil(principal / paymentWithExtra) : n;
    } else if (paymentWithExtra <= basePayment) {
      periodsExtra = n;
    } else {
      while (remaining > 0 && periodsExtra < n * 2) {
        const interest = remaining * r;
        const principalPaid = paymentWithExtra - interest;
        if (principalPaid <= 0) {
          periodsExtra = n;
          break;
        }
        remaining -= principalPaid;
        periodsExtra++;
      }
    }

    const totalPaidExtra = paymentWithExtra * periodsExtra;
    const totalInterestExtra =
      r === 0 ? 0 : Math.max(totalPaidExtra - principal, 0);

    const baseYears = n / paymentsPerYear;
    const extraYears = periodsExtra / paymentsPerYear;

    resultPaymentEl.textContent = formatCurrency(paymentWithExtra);
    resultPaymentLabelEl.textContent =
      "Per " +
      (freq === "weekly" ? "week" : freq === "fortnightly" ? "fortnight" : "month");

    resultInterestBaseEl.textContent = formatCurrency(totalInterestBase);
    resultInterestExtraEl.textContent = formatCurrency(totalInterestExtra);

    resultTermBaseEl.textContent = baseYears.toFixed(1) + " years";
    resultTermExtraEl.textContent = extraYears.toFixed(1) + " years";

    lastFreq = freq;
    lastPaymentPerFreq = paymentWithExtra;
    lastPrincipal = principal;
    lastTermYears = termYears;
    lastRate = rate;

    updateAffordability();
    updateFutureRateView();
    persistMortgageState();
  }

  function updateAffordability() {
    const weeklyPayment = toWeekly(lastPaymentPerFreq, lastFreq);
    const paymentView = fromWeekly(weeklyPayment, viewMode);
    const surplusView = fromWeekly(plannerSurplusWeekly, viewMode);

    if (!isFinite(paymentView) || paymentView <= 0) {
      paymentDisplayEl.textContent = "0";
      coverageLabelEl.textContent = "Run a calculation";
      coverageLabelEl.classList.remove("deficit");
      coverageLabelEl.classList.add("surplus");
      afterPaymentEl.textContent = "0";
      coverageBarEl.style.width = "0%";
      coverageNoteEl.textContent = "Run a calculation to compare.";
      coverageTagEl.textContent = "‚Äî";
      coverageTagEl.classList.remove("good", "bad");
      return;
    }

    paymentDisplayEl.textContent = paymentView.toFixed(2);

    if (surplusView <= 0) {
      coverageLabelEl.textContent = "Set a surplus in the main planner";
      coverageLabelEl.classList.remove("deficit");
      coverageLabelEl.classList.add("surplus");
      afterPaymentEl.textContent = "0";
      coverageBarEl.style.width = "100%";
      coverageNoteEl.textContent = "No surplus recorded yet.";
      coverageTagEl.textContent = "Info";
      coverageTagEl.classList.remove("good", "bad");
      return;
    }

    const remaining = surplusView - paymentView;
    const ratio = paymentView / surplusView;
    afterPaymentEl.textContent = remaining <= 0 ? "0" : remaining.toFixed(2);

    let label;
    if (ratio <= 0.25) {
      label = "Comfortable (‚â§ 25% of surplus)";
    } else if (ratio <= 0.5) {
      label = "OK (25‚Äì50% of surplus)";
    } else if (ratio <= 0.75) {
      label = "Tight (50‚Äì75% of surplus)";
    } else {
      label = "Very tight (‚â• 75% of surplus)";
    }

    coverageLabelEl.textContent = label;
    coverageLabelEl.classList.toggle("surplus", ratio <= 0.75);
    coverageLabelEl.classList.toggle("deficit", ratio > 0.75);

    const barPct = Math.max(0, Math.min(ratio * 100, 120));
    coverageBarEl.style.width = barPct + "%";

    coverageNoteEl.textContent =
      "Payment is " + Math.round(ratio * 100) + "% of your surplus in this view.";
    coverageTagEl.textContent = ratio <= 0.75 ? "Within surplus" : "Over surplus";
    coverageTagEl.classList.toggle("good", ratio <= 0.75);
    coverageTagEl.classList.toggle("bad", ratio > 0.75);
  }

  function updateFutureRateView() {
    const futureRate = parseFloat(futureRateInput.value || "0");
    if (!isFinite(futureRate) || futureRate <= 0 || lastPrincipal <= 0 || lastTermYears <= 0) {
      futureBox.style.display = "none";
      futurePaymentEl.textContent = "‚Äî";
      futureInterestEl.textContent = "‚Äî";
      futureChangeEl.textContent = "‚Äî";
      futureNoteEl.textContent =
        "Enter a future interest rate to see how repayments and total interest could change.";
      return;
    }

    const paymentsPerYear =
      lastFreq === "weekly" ? 52 : lastFreq === "fortnightly" ? 26 : 12;
    const n = lastTermYears * paymentsPerYear;
    const currentPayment = annuityPayment(
      lastPrincipal,
      lastRate,
      lastTermYears,
      paymentsPerYear
    );
    const currentInterest =
      currentPayment * n - lastPrincipal;

    const futurePayment = annuityPayment(
      lastPrincipal,
      futureRate,
      lastTermYears,
      paymentsPerYear
    );
    const futureInterest =
      futurePayment * n - lastPrincipal;

    futurePaymentEl.textContent = formatCurrency(futurePayment);
    futureInterestEl.textContent = formatCurrency(futureInterest);

    const diff = futurePayment - currentPayment;
    const sign = diff >= 0 ? "+" : "‚Äì";
    futureChangeEl.textContent =
      sign + formatCurrency(Math.abs(diff)) + " per " +
      (lastFreq === "weekly"
        ? "week"
        : lastFreq === "fortnightly"
        ? "fortnight"
        : "month") +
      " (repayment change)";
    futureBox.style.display = "block";
    futureNoteEl.textContent =
      "Comparison assumes the same term and loan amount; it only changes the interest rate.";
  }

  function persistMortgageState() {
    const state = {
      price: priceInput.value || "",
      deposit: depositInput.value || "",
      rate: rateInput.value || "",
      futureRate: futureRateInput.value || "",
      term: termInput.value || "",
      freq: freqInput.value || "monthly",
      extra: extraInput.value || "",
      viewMode
    };
    try {
      localStorage.setItem(STORAGE_KEY_MORTGAGE, JSON.stringify(state));
    } catch (e) {
      // ignore
    }
  }

  function restoreMortgageState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_MORTGAGE);
      if (!raw) return;
      const state = JSON.parse(raw);
      if (!state || typeof state !== "object") return;

      if (typeof state.price === "string") priceInput.value = state.price;
      if (typeof state.deposit === "string") depositInput.value = state.deposit;
      if (typeof state.rate === "string") rateInput.value = state.rate;
      if (typeof state.futureRate === "string")
        futureRateInput.value = state.futureRate;
      if (typeof state.term === "string") termInput.value = state.term;
      if (typeof state.extra === "string") extraInput.value = state.extra;
      if (typeof state.freq === "string") freqInput.value = state.freq;

      if (
        state.viewMode === "weekly" ||
        state.viewMode === "fortnightly" ||
        state.viewMode === "monthly" ||
        state.viewMode === "yearly"
      ) {
        viewMode = state.viewMode;
      }

      [...viewToggle.querySelectorAll(".type-option")].forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.view === viewMode);
      });

      if (
        state.price ||
        state.deposit ||
        state.rate ||
        state.term
      ) {
        calculate();
      }
    } catch (e) {
      // ignore
    }
  }

  viewToggle.addEventListener("click", (e) => {
    const btn = e.target.closest(".type-option");
    if (!btn) return;
    viewMode = btn.dataset.view || "monthly";
    viewToggle
      .querySelectorAll(".type-option")
      .forEach((b) => b.classList.toggle("active", b === btn));
    loadPlannerSurplus();
    updateAffordability();
    persistMortgageState();
  });

  calcBtn.addEventListener("click", calculate);

  [priceInput, depositInput, rateInput, futureRateInput, termInput, extraInput, freqInput].forEach(
    (el) => {
      el.addEventListener("change", persistMortgageState);
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter") calculate();
      });
    }
  );

  futureRateInput.addEventListener("input", () => {
    updateFutureRateView();
    persistMortgageState();
  });

  detailsToggle.addEventListener("click", () => {
    const open = detailsBox.style.display === "block";
    detailsBox.style.display = open ? "none" : "block";
    detailsToggle.textContent = open
      ? "Show calculation notes"
      : "Hide calculation notes";
  });

  addToPlannerBtn.addEventListener("click", () => {
    if (!lastPaymentPerFreq || lastPaymentPerFreq <= 0) {
      inputError.textContent =
        "Run a calculation first before adding the mortgage to the planner.";
      return;
    }
    inputError.textContent = "";

    try {
      const raw = localStorage.getItem(STORAGE_KEY_ITEMS);
      const items = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(items)) return;

      const label = "Mortgage repayment";
      const freq = lastFreq === "weekly" || lastFreq === "fortnightly" || lastFreq === "monthly" || lastFreq === "yearly"
        ? lastFreq
        : "monthly";

      let existing = items.find(
        (i) => i && i.label === label && i.type === "need"
      );
      if (existing) {
        existing.amount = lastPaymentPerFreq;
        existing.frequency = freq;
        existing.enabled = true;
        existing.color = existing.color || "blue";
      } else {
        const maxId = items.reduce(
          (max, i) => (i && typeof i.id === "number" ? Math.max(max, i.id) : max),
          0
        );
        items.push({
          id: maxId + 1,
          type: "need",
          label,
          amount: lastPaymentPerFreq,
          frequency: freq,
          enabled: true,
          color: "blue"
        });
      }

      localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(items));
      addToPlannerBtn.classList.remove("bad");
      addToPlannerBtn.classList.add("good");
      addToPlannerBtn.textContent = "Saved to planner as a need";
      setTimeout(() => {
        addToPlannerBtn.classList.remove("good");
        addToPlannerBtn.textContent = "Add / update mortgage in planner";
      }, 2000);
    } catch (e) {
      addToPlannerBtn.classList.remove("good");
      addToPlannerBtn.classList.add("bad");
      addToPlannerBtn.textContent = "Could not save to planner";
      setTimeout(() => {
        addToPlannerBtn.classList.remove("bad");
        addToPlannerBtn.textContent = "Add / update mortgage in planner";
      }, 2500);
    }
  });

  loadPlannerSurplus();
  restoreMortgageState();
  updateAffordability();
</script>
</body>
</html>
